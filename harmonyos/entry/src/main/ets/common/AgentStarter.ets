import http from '@ohos.net.http';
import util from '@ohos.util';
import { KeyCenter } from './KeyCenter';

/**
 * Agent Starter
 * Unified interface for starting/stopping agents
 * Only the base URL differs between local server and Agora API
 */
export class AgentStarter {
  private static readonly JSON_MEDIA_TYPE = 'application/json; charset=utf-8';
  // Switch between local server and Agora API by commenting/uncommenting the lines below
  private static readonly AGORA_API_BASE_URL = 'https://api.sd-rtn.com/cn/api/conversational-ai-agent/v2/projects';
  // private static readonly AGORA_API_BASE_URL = 'http://10.103.1.61:8080'; // Local server (for development)
  private static readonly DEFAULT_AGENT_RTC_UID = '1009527';

  /**
   * Start an agent
   * Unified interface: same format for both local server and Agora API
   *
   * @param channelName Channel name for the agent
   * @param agentRtcUid Agent RTC UID (optional, defaults to "1009527")
   * @param token Agent token (required, should be generated by client)
   * @returns Promise with agentId string
   */
  static async startAgentAsync(
    channelName: string,
    agentRtcUid: string = AgentStarter.DEFAULT_AGENT_RTC_UID,
    token: string
  ): Promise<string> {
    try {
      const projectId = KeyCenter.AGORA_APP_ID;
      const url = `${AgentStarter.AGORA_API_BASE_URL}/${projectId}/join/`;

      const requestBody = AgentStarter.buildJsonPayload(
        channelName,
        KeyCenter.PIPELINE_ID,
        channelName,
        agentRtcUid,
        token,
        ['*']
      );

      // Build authorization header
      const authorization = AgentStarter.genAuthorization(KeyCenter.REST_KEY, KeyCenter.REST_SECRET);

      // Print curl command for debugging
      const curlCommand = `curl -X POST "${url}" \\
  -H "Content-Type: ${AgentStarter.JSON_MEDIA_TYPE}" \\
  -H "Authorization: ${authorization}" \\
  -d '${JSON.stringify(requestBody)}'`;
      console.info('AgentStarter', `[CURL] Start Agent:\n${curlCommand}`);

      const httpRequest = http.createHttp();
      const response = await httpRequest.request(url, {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': AgentStarter.JSON_MEDIA_TYPE,
          'Authorization': authorization
        },
        extraData: JSON.stringify(requestBody)
      });

      httpRequest.destroy();

      // Print response details
      const responseBody = response.result?.toString() || '';
      console.info('AgentStarter', `[Response] Start Agent: httpCode=${response.responseCode}`);
      console.info('AgentStarter', `[Response] Body: ${responseBody}`);

      // Check if response is successful (similar to response.isSuccessful in Kotlin)
      if (response.responseCode !== 200) {
        const errorBody = response.result?.toString() || 'Unknown error';
        throw new Error(
          `Start agent error: httpCode=${response.responseCode}, httpMsg=${errorBody}`
        );
      }

      // Parse response body
      const bodyString = response.result?.toString();
      if (!bodyString) {
        throw new Error('Response body is null');
      }

      const bodyJson = JSON.parse(bodyString) as Record<string, Object>;

      // Unified response format: {"agent_id": "..."}
      const agentId = bodyJson['agent_id'] as string | undefined;
      if (!agentId || agentId.trim() === '') {
        throw new Error(`Failed to parse agentId from response: ${bodyString}`);
      }

      return agentId;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : JSON.stringify(error);
      console.error('AgentStarter', `Failed to start agent: ${errorMessage}`);
      throw new Error(`Failed to start agent: ${errorMessage}`);
    }
  }

  /**
   * Build JSON payload for Agora API
   * Similar to Kotlin: buildJsonPayload
   */
  private static buildJsonPayload(
    name: string,
    pipelineId: string,
    channel: string,
    agentRtcUid: string,
    token: string,
    remoteRtcUids: string[]
  ): Record<string, Object> {
    const properties: Record<string, Object> = {};
    properties['channel'] = channel;
    properties['agent_rtc_uid'] = agentRtcUid;
    properties['remote_rtc_uids'] = remoteRtcUids;
    properties['token'] = token;

    const parameters: Record<string, Object> = {};
    parameters['data_channel'] = "datastream"
    const transcript: Record<string, Object> = {};
    transcript['enable_words'] = false;
    parameters['transcript'] = transcript
    properties['parameters'] = parameters;

    const advancedFeatures: Record<string, Object> = {};
    advancedFeatures['enable_rtm'] = false
    properties['advanced_features'] = advancedFeatures

    const payload: Record<string, Object> = {};
    payload['name'] = name;
    payload['pipeline_id'] = pipelineId;
    payload['properties'] = properties;

    return payload;
  }

  /**
   * Generate Base64 encoded authorization header
   * Similar to Kotlin: Base64Encoding.gen(key, secret)
   * Format: "Basic base64(key:secret)"
   */
  private static genAuthorization(key: string, secret: string): string {
    const credentials = `${key}:${secret}`;
    // Convert string to Uint8Array
    const credentialsBytes = new Uint8Array(credentials.length);
    for (let i = 0; i < credentials.length; i++) {
      credentialsBytes[i] = credentials.charCodeAt(i);
    }
    // Encode to Base64
    const base64Helper = new util.Base64Helper();
    const encoded = base64Helper.encodeToStringSync(credentialsBytes);
    return `Basic ${encoded}`;
  }

  /**
   * Stop an agent
   * Unified interface: same format for both local server and Agora API
   *
   * @param agentId Agent ID to stop
   * @returns Promise that resolves when agent is stopped
   */
  static async stopAgentAsync(agentId: string): Promise<void> {
    try {
      const projectId = KeyCenter.AGORA_APP_ID;
      const url = `${AgentStarter.AGORA_API_BASE_URL}/${projectId}/agents/${agentId}/leave`;

      // Build authorization header
      const authorization = AgentStarter.genAuthorization(KeyCenter.REST_KEY, KeyCenter.REST_SECRET);

      // Print curl command for debugging (matching Kotlin format)
      const curlCommand = `curl -X POST -H "Content-Type:${AgentStarter.JSON_MEDIA_TYPE};Authorization:${authorization}" -d '' "${url}"`;
      console.info('AgentStarter', `[CURL] Stop Agent:\n${curlCommand}`);

      const httpRequest = http.createHttp();
      // For POST without body, try not setting extraData or use undefined
      const response = await httpRequest.request(url, {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': AgentStarter.JSON_MEDIA_TYPE,
          'Authorization': authorization
        }
        // Don't set extraData for empty body - let it be undefined
      });

      httpRequest.destroy();

      // Print response details
      const responseBody = response.result?.toString() || '';
      console.info('AgentStarter', `[Response] Stop Agent: httpCode=${response.responseCode}`);
      console.info('AgentStarter', `[Response] Body: ${responseBody}`);

      // Check if response is successful
      if (response.responseCode !== 200) {
        const errorBody = response.result?.toString() || 'Unknown error';
        throw new Error(
          `Stop agent error: httpCode=${response.responseCode}, httpMsg=${errorBody}`
        );
      }

      // Unified response: just check status code
      return;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : JSON.stringify(error);
      console.error('AgentStarter', `Failed to stop agent: ${errorMessage}`);
      throw new Error(`Failed to stop agent: ${errorMessage}`);
    }
  }

  /**
   * Check if the server is available
   *
   * @returns Promise with true if server is available, false otherwise
   */
  static async checkServerHealth(): Promise<boolean> {
    try {
      // Health check only works for local server
      // For Agora API, skip health check or use a different endpoint
      if (AgentStarter.AGORA_API_BASE_URL.startsWith('http://')) {
        const url = `${AgentStarter.AGORA_API_BASE_URL}/health`;

        const httpRequest = http.createHttp();
        const response = await httpRequest.request(url, {
          method: http.RequestMethod.GET
        });

        httpRequest.destroy();

        return response.responseCode === 200;
      } else {
        // Agora API doesn't have a health endpoint, return success
        return true;
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : JSON.stringify(error);
      console.error('AgentStarter', `Health check failed: ${errorMessage}`);
      return false;
    }
  }
}

